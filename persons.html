// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ global
let externalPersonCounter = 5001;
let persons = [];
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxmJkJGgOiairw-SIcJSDr2depuM9uWRslLjhs-mXARuTCKRQl50v1qqS5GPDRd3k45Dg/exec';

// ØªØ§Ø¨Ø¹ ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ Ø´Ø®Øµ
function togglePersonCode() {
    const personType = document.querySelector('input[name="personType"]:checked').value;
    const personCodeInput = document.getElementById('personCode');
    
    if (personType === 'external') {
        personCodeInput.value = externalPersonCounter;
        personCodeInput.readOnly = true;
        personCodeInput.style.background = '#f0f0f0';
    } else {
        personCodeInput.value = '';
        personCodeInput.readOnly = false;
        personCodeInput.style.background = 'white';
    }
}

// ØªØ§Ø¨Ø¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
function clearForm() {
    document.getElementById('personForm').reset();
    togglePersonCode();
}

// ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
async function savePersonToSheets(personData) {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(personData)
        });
        
        const result = await response.json();
        return result.success;
    } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ:', error);
        return false;
    }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Google Sheets
async function loadPersonsFromSheets() {
    try {
        const response = await fetch(SCRIPT_URL);
        const data = await response.json();
        return Array.isArray(data) ? data : [];
    } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡:', error);
        return [];
    }
}

// ØªØ§Ø¨Ø¹ Ø«Ø¨Øª ÙØ±Ù…
document.getElementById('personForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const personData = {
        code: formData.get('personCode'),
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        type: formData.get('personType'),
        startDate: formData.get('startDate'),
        endDate: formData.get('endDate'),
        groupCode: formData.get('groupCode'),
        position: formData.get('position'),
        accuracyRate: formData.get('accuracyRate'),
        ratioRate: formData.get('ratioRate'),
        description: formData.get('description')
    };
    
    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
    if (!personData.code) {
        alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø´Ø®Øµ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
    const success = await savePersonToSheets(personData);
    
    if (success) {
        // Ø§Ú¯Ø± Ø®Ø§Ø±Ø¬ÛŒ Ù‡Ø³ØªØŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø±Ùˆ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        if (personData.type === 'external') {
            externalPersonCounter++;
        }
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Sheets
        await loadAllPersons();
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
        clearForm();
        
        alert(`âœ… Ø´Ø®Øµ "${personData.firstName} ${personData.lastName}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Google Sheets Ø«Ø¨Øª Ø´Ø¯!`);
    } else {
        alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Google Sheets!');
    }
});

// ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ø§Ø´Ø®Ø§Øµ
async function loadAllPersons() {
    persons = await loadPersonsFromSheets();
    updatePersonsTable();
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„
function updatePersonsTable() {
    const tbody = document.getElementById('personsTableBody');
    tbody.innerHTML = '';
    
    if (persons.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Ù‡ÛŒÚ† Ø´Ø®ØµÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
        return;
    }
    
    persons.forEach((person, index) => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${person.code}</td>
            <td>${person.firstName} ${person.lastName}</td>
            <td>
                <span class="person-type-${person.type}">
                    ${person.type === 'internal' ? 'Ø¯Ø§Ø®Ù„ÛŒ' : 'Ø®Ø§Ø±Ø¬ÛŒ'}
                </span>
            </td>
            <td>${person.groupCode}</td>
            <td>${person.position}</td>
            <td>${person.startDate}</td>
            <td>${person.accuracyRate}</td>
            <td>
                <button onclick="editPerson('${person.code}')" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">âœï¸</button>
                <button onclick="deletePerson('${person.code}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">ğŸ—‘ï¸</button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// ØªÙˆØ§Ø¨Ø¹ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø­Ø°Ù (Ù…ÙˆÙ‚Øª)
function editPerson(personCode) {
    alert('ÙˆÛŒÚ˜Ú¯ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯');
}

function deletePerson(personCode) {
    alert('ÙˆÛŒÚ˜Ú¯ÛŒ Ø­Ø°Ù Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯');
}

// Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', async function() {
    togglePersonCode();
    await loadAllPersons();
});
