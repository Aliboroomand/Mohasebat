<script>
    // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ global
    let externalPersonCounter = 5001;
    let persons = [];

    // ØªØ§Ø¨Ø¹ ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ Ø´Ø®Øµ
    function togglePersonCode() {
        const personType = document.querySelector('input[name="personType"]:checked').value;
        const personCodeInput = document.getElementById('personCode');
        
        if (personType === 'external') {
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ú©Ø¯ Ø®Ø§Ø±Ø¬ÛŒ Ù…ÙˆØ¬ÙˆØ¯
            const savedPersons = JSON.parse(localStorage.getItem('persons') || '[]');
            const externalCodes = savedPersons
                .filter(p => p.type === 'external')
                .map(p => parseInt(p.code))
                .filter(code => !isNaN(code) && code >= 5001);
            
            const maxCode = externalCodes.length > 0 ? Math.max(...externalCodes) : 5000;
            externalPersonCounter = maxCode + 1;
            
            personCodeInput.value = externalPersonCounter;
            personCodeInput.readOnly = true;
            personCodeInput.style.background = '#f0f0f0';
        } else {
            personCodeInput.value = '';
            personCodeInput.readOnly = false;
            personCodeInput.style.background = 'white';
        }
    }
    
    // ØªØ§Ø¨Ø¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
    function clearForm() {
        document.getElementById('personForm').reset();
        togglePersonCode();
    }

    // ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
    async function savePersonToSheets(personData) {
        try {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ
            const personWithMeta = {
                ...personData,
                id: Date.now(),
                registerDate: new Date().toLocaleDateString('fa-IR'),
                timestamp: new Date().toISOString()
            };
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
            const savedPersons = JSON.parse(localStorage.getItem('persons') || '[]');
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø´Ø®Øµ Ø¬Ø¯ÛŒØ¯
            savedPersons.push(personWithMeta);
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            localStorage.setItem('persons', JSON.stringify(savedPersons));
            
            console.log('âœ… Ø´Ø®Øµ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯:', personWithMeta);
            console.log('ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ø´Ø®Ø§Øµ:', savedPersons.length);
            
            return true;
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ:', error);
            return false;
        }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² localStorage
    async function loadPersonsFromSheets() {
        try {
            const savedPersons = JSON.parse(localStorage.getItem('persons') || '[]');
            console.log('ğŸ“– Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯:', savedPersons.length, 'Ø´Ø®Øµ');
            return savedPersons;
        } catch (error) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡:', error);
            return [];
        }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ø§Ø´Ø®Ø§Øµ
    async function loadAllPersons() {
        persons = await loadPersonsFromSheets();
        updatePersonsTable();
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„
    function updatePersonsTable() {
        const tbody = document.getElementById('personsTableBody');
        tbody.innerHTML = '';
        
        if (persons.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Ù‡ÛŒÚ† Ø´Ø®ØµÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
            return;
        }
        
        persons.forEach((person, index) => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${person.code}</strong></td>
                <td>${person.firstName} ${person.lastName}</td>
                <td>
                    <span class="person-type-${person.type}">
                        ${person.type === 'internal' ? 'Ø¯Ø§Ø®Ù„ÛŒ' : 'Ø®Ø§Ø±Ø¬ÛŒ'}
                    </span>
                </td>
                <td>${person.groupCode}</td>
                <td>${person.position}</td>
                <td>${person.startDate}</td>
                <td>${person.accuracyRate}</td>
                <td>
                    <button onclick="editPerson('${person.code}')" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">âœï¸</button>
                    <button onclick="deletePerson('${person.code}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">ğŸ—‘ï¸</button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
    async function handleFormSubmit(e) {
        e.preventDefault();
        console.log('Form submitted!'); // Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        
        const formData = new FormData(document.getElementById('personForm'));
        const personData = {
            code: formData.get('personCode'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            type: formData.get('personType'),
            startDate: formData.get('startDate'),
            endDate: formData.get('endDate'),
            groupCode: formData.get('groupCode'),
            position: formData.get('position'),
            accuracyRate: formData.get('accuracyRate'),
            ratioRate: formData.get('ratioRate'),
            description: formData.get('description')
        };
        
        console.log('Person data:', personData); // Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        
        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
        if (!personData.code) {
            alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø´Ø®Øµ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            return;
        }
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
        const success = await savePersonToSheets(personData);
        
        if (success) {
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            await loadAllPersons();
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
            clearForm();
            
            alert(`âœ… Ø´Ø®Øµ "${personData.firstName} ${personData.lastName}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!`);
        } else {
            alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø´Ø®Øµ!');
        }
    }

    // ØªÙˆØ§Ø¨Ø¹ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø­Ø°Ù
    function editPerson(personCode) {
        const savedPersons = JSON.parse(localStorage.getItem('persons') || '[]');
        const person = savedPersons.find(p => p.code === personCode);
        
        if (person) {
            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®Øµ
            document.querySelector(`input[name="personType"][value="${person.type}"]`).checked = true;
            document.getElementById('personCode').value = person.code;
            document.getElementById('firstName').value = person.firstName;
            document.getElementById('lastName').value = person.lastName;
            document.getElementById('startDate').value = person.startDate;
            document.getElementById('endDate').value = person.endDate || '';
            document.getElementById('groupCode').value = person.groupCode;
            document.getElementById('position').value = person.position;
            document.getElementById('accuracyRate').value = person.accuracyRate;
            document.getElementById('ratioRate').value = person.ratioRate;
            document.getElementById('description').value = person.description || '';
            
            togglePersonCode();
            
            alert('ÙØ±Ù… Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®Øµ Ù¾Ø± Ø´Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.');
        }
    }

    function deletePerson(personCode) {
        if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø´Ø®Øµ Ø¨Ø§ Ú©Ø¯ ${personCode} Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) {
            const savedPersons = JSON.parse(localStorage.getItem('persons') || '[]');
            const updatedPersons = savedPersons.filter(p => p.code !== personCode);
            
            localStorage.setItem('persons', JSON.stringify(updatedPersons));
            loadAllPersons();
            
            alert('âœ… Ø´Ø®Øµ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.');
        }
    }

    // ØªØ§Ø¨Ø¹ Ø®Ø±ÙˆØ¬ÛŒ CSV
    function exportToCSV() {
        const savedPersons = JSON.parse(localStorage.getItem('persons') || '[]');
        
        if (savedPersons.length === 0) {
            alert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ export ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');
            return;
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ø¯Ø± CSV
        let csv = 'Ú©Ø¯ Ø´Ø®Øµ,Ù†Ø§Ù…,Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ,Ù†ÙˆØ¹,ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹,ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†,Ú©Ø¯ Ú¯Ø±ÙˆÙ‡,Ø¬Ø§ÛŒÚ¯Ø§Ù‡,Ø¶Ø±ÛŒØ¨ Ø¯Ù‚Øª,Ø¶Ø±ÛŒØ¨ Ù†Ø³Ø¨Øª,ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª,ØªÙˆØ¶ÛŒØ­Ø§Øª\n';
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        savedPersons.forEach(person => {
            const row = [
                `"${person.code}"`,
                `"${person.firstName}"`,
                `"${person.lastName}"`,
                `"${person.type === 'internal' ? 'Ø¯Ø§Ø®Ù„ÛŒ' : 'Ø®Ø§Ø±Ø¬ÛŒ'}"`,
                `"${person.startDate}"`,
                `"${person.endDate || ''}"`,
                `"${person.groupCode}"`,
                `"${person.position}"`,
                `"${person.accuracyRate}"`,
                `"${person.ratioRate}"`,
                `"${person.registerDate}"`,
                `"${person.description || ''}"`
            ].join(',');
            
            csv += row + '\n';
        });
        
        // Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `Ø§Ø´Ø®Ø§Øµ_${new Date().toLocaleDateString('fa-IR')}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`âœ… ÙØ§ÛŒÙ„ CSV Ø¨Ø§ ${savedPersons.length} Ø±Ú©ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯.`);
    }

    // ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ú©Ø§Ù…Ù„ Ù„ÙˆØ¯ Ø´Ø¯
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded!'); // Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        togglePersonCode();
        loadAllPersons();
    });
</script>
<script src="data-store.js"></script>

